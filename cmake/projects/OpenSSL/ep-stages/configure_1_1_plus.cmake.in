cmake_minimum_required(VERSION 3.2)

if(NOT "@NASM_ROOT@" STREQUAL "")
  set(ENV{PATH} "@NASM_ROOT@/bin;$ENV{PATH}")
endif()

if("@openssl_install_dir@" STREQUAL "")
  message(FATAL_ERROR "openssl_install_dir is empty")
endif()

if("@openssl_dir@" STREQUAL "")
  message(FATAL_ERROR "openssl_dir is empty")
endif()

if("@MSVC@")
  # Unset as we are already in a msvc environment 
  # and the openssl perl script will figure things out.
  # The created variable content by CMake is unqouted and will cause issues
  unset(ENV{CC})
  unset(ENV{CXX})
  unset(ENV{RC})
  unset(ENV{AR})
  unset(ENV{RUNLIB})
else()
  set(log_opts "")
endif()


execute_process(COMMAND
  perl Configure @arch@ @opt@ @shared@ "--prefix=@openssl_install_dir@" "--openssldir=@openssl_dir@" RESULT_VARIABLE result)

if(NOT result EQUAL 0)
  message(FATAL_ERROR "OpenSSL configure failed: ${result}")
endif()

execute_process(COMMAND
  nmake RESULT_VARIABLE result)

if(NOT result EQUAL 0)
  message(FATAL_ERROR "OpenSSL nmake failed: ${result}")
endif()
